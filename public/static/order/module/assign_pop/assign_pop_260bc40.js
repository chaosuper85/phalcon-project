define("order/module/assign_pop/assign_pop",function(require,exports,module){function AssignPop(e){function t(){{var e=(this.type=_.type,this.flag=0);this.DOM={}}this.DOM={title:this.pop.find(".assignPop-title .title-text"),comfireBtn:this.pop.find(".assignPop-title .assignPop-comfire .comfireBtn"),cancelBtn:this.pop.find(".assignPop-title .assignPop-cancel .cancelBtn"),addBtn:this.pop.find("#assignPop .add-other-BoxInfo"),delBtn:$('<a class="del-btn" href="javaScript:">删除</a>'),driver:this.pop.find("#driver-selector"),items_container:this.pop.find(".assignPop-address-info"),items_complete_container:this.pop.find(".assignPop-address-complete-info"),items:this.pop.find(".assign-adrress-items")},this.can_open=_.can_open,this.msg=_.msg,this.driverSelector,this.address_list=[],e=this.DOM.items.length,this.init_popup();var t=this;this.DOM.addBtn.on("click",function(){0==e&&(e=1),e++;var d=($(this),$(item_tpl({flag:e,assign_driver_id:"",order_product_addressid:"",order_product_timeid:"",canChange:!0})));t.DOM.items_container.append(d);var i=new select({width:380,container:d.find(".boxData-selector"),options:[],defaultText:"请先选择装箱地址",defaultValue:"0",options_max_height:160,onSelectChange:function(e,t,d){d.select.select_box.removeClass("error")}}),s=new select({width:380,container:d.find(".boxAddress-selector"),options:a,defaultText:"请选择装箱地址",defaultValue:"0",onSelectChange:function(e,t,d){d.select.select_box.removeClass("error"),i.setSelectedVal(""),i.setSelectedText("请先选择装箱地址"),i.setOptions([]),function(e){o=[];for(var t=0;t<_.select_options.length;t++)if(e==_.select_options[t].product_address_id)for(var d=_.select_options[t].box_date,i=0;i<d.length;i++)o.push({value:d[i].product_time_id,text:d[i].product_supply_time})}(e),i.setSelectedText("请选择装箱时间"),i.setOptions(o)}});t.address_list.push({address:s,time:i,assign_id:d.find("input[name='assign_driver_id']"),order_product_addressid:d.find("input[name='order_product_addressid']"),order_product_timeid:d.find("input[name='order_product_timeid']"),flag:e})}),this.pop.on("mouseover",".assign-adrress-items",function(){var e=$(this),d=e.attr("data-flag"),i=e.find(".assign-delContainer");1!=d&&(i.html(t.DOM.delBtn),t.DOM.delBtn.show(),t.DOM.delBtn.attr("data-flag",d))}),this.pop.on("mouseleave",".assign-adrress-items",function(){t.DOM.delBtn.hide(),t.DOM.delBtn.removeAttr("data-flag")}),this.pop.on("click",".del-btn",function(){var e,d=$(this),i=d.attr("data-flag");if(1!=i&&0!=t.address_list.length){for(e=0;e<t.address_list.length;e++)i==t.address_list[e].flag&&t.address_list.splice(e,1);d.parents(".assign-adrress-items").remove()}}),this.DOM.comfireBtn.on("click",function(){d(t,$(this))}),this.DOM.cancelBtn.on("click",function(){t.hide()})}function d(e,t){var d=e.driverSelector.val(),r=function(e){var t=e.indexOf("/"),d=e.substring(0,t),i=e.substring(t+1,e.length);return{driver_name:d,car_num:i}}(e.driverSelector.text()),a={driver_info:{driver_id:d,driver_name:r.driver_name,car_num:r.car_num},address_info:[]};if(!d||0==d)return e.driverSelector.select.select_box.addClass("error"),void s(e.driverSelector.select.select_box);var o=i(e.address_list);if(o&&0!==o.length){var n,c=o.length;for(n=0;c>n;n++)o[n].driver_user_id=d,o[n].order_freight_boxid=_.data.id,o[n].order_freight_id=_.data.orderId,a.address_info.push({product_address_id:o[n].order_product_addressid,box_address_detail:o[n].order_product_address_text,product_time_id:o[n].order_product_timeid,box_time:o[n].order_product_time_text}),delete o[n].order_product_address_text,delete o[n].order_product_time_text,o[n].assign_id||delete o[n].assign_id,o[n].order_product_addressid||delete o[n].order_product_addressid,o[n].order_product_timeid||delete o[n].order_product_timeid;var p=t.text();t.html("正在提交..."),t.attr("disabled","disabled"),XDD.Request({url:"/carteam/order/assign_edit_save",data:{order_assign_info:o},success:function(d){0==d.error_code?(e.hide(),_alert(l),window.location.reload(),"function"==typeof e.onComplete&&e.onComplete(a)):(e.hide(),_alert(d.error_msg||"未知错误！")),t.html(p),t.removeAttr("disabled")},error:function(){t.html(p),t.removeAttr("disabled")}},!0)}}function i(e){var t,d=e.length,i=!0,r=[];for(t=0;d>t;t++)e[t].address&&e[t].address?e[t].address.val()&&0!=e[t].address.val()?e[t].time.val()&&0!=e[t].time.val()?r.push({order_product_addressid:e[t].address.val(),order_product_address_text:e[t].address.text(),order_product_timeid:e[t].time.val(),order_product_time_text:e[t].time.text(),assign_id:e[t].assign_id.val()}):(e[t].time.select.select_box.addClass("error"),s(e[t].time.select.select_box),i=!1):(e[t].address.select.select_box.addClass("error"),s(e[t].address.select.select_box),i=!1):r.push({order_product_addressid:e[t].order_product_addressid.val(),order_product_timeid:e[t].order_product_timeid.val(),order_product_address_text:"",order_product_time_text:"",assign_id:e[t].assign_id.val()});return i?r:i?void 0:!1}function s(e){e.animate({marginLeft:"-1px"},40).animate({marginLeft:"2px"},40).animate({marginLeft:"-2px"},40).animate({marginLeft:"1px"},40)}var r,a=[],o=[],n={data:{id:"",carTeam_id:"",address_info:[]},carTeam_id:"",select_options:[],type:"add",can_open:!1,msg:"未加载完数据，请重试！"},_=$.extend({},n,e);if("add"===_.type){r="添加司机/装箱信息";var l="添加成功！"}else{r="修改司机/装箱信息";var l="修改成功！"}return function(){for(var e=0;e<_.select_options.length;e++)a.push({value:_.select_options[e].product_address_id,text:_.select_options[e].box_address_detail})}(),t.prototype=new popup({height:550,width:700,isNotCloseIcon:!0,tpl:tpl}),t.prototype.constructor=t,t.prototype.setAdd=function(e){flag=this.flag=1,type=this.type="add",r="添加司机/装箱信息",l="添加成功！",this.address_list=[],this.DOM.items_container.html(""),this.DOM.items_complete_container.html(""),this.driverSelector.setSelectedText("请选择司机"),this.driverSelector.setSelectedVal(""),this.pop.find(".driver-name").text("").hide(),this.DOM.driver.show();var t=$(item_tpl({flag:flag,canChange:!0,assign_driver_id:"",order_product_addressid:"",order_product_timeid:""}));this.DOM.items_container.html(t);var d=new select({width:380,container:t.find(".boxData-selector"),options:[],defaultText:"请先选择装箱地址",defaultValue:"0",options_max_height:160,onSelectChange:function(e,t,d){d.select.select_box.removeClass("error")}}),i=new select({width:380,container:t.find(".boxAddress-selector"),options:a,defaultText:"请选择装箱地址",defaultValue:"0",onSelectChange:function(e,t,i){i.select.select_box.removeClass("error"),d.setSelectedVal(""),d.setSelectedText("请先选择装箱地址"),d.setOptions([]),function(e){o=[];for(var t=0;t<_.select_options.length;t++)if(e==_.select_options[t].product_address_id)for(var d=_.select_options[t].box_date,i=0;i<d.length;i++)o.push({value:d[i].product_time_id,text:d[i].product_supply_time})}(e),d.setSelectedText("请选择装箱时间"),d.setOptions(o)}});this.address_list.push({address:i,time:d,assign_id:t.find("input[name='assign_driver_id']"),order_product_addressid:t.find("input[name='order_product_addressid']"),order_product_timeid:t.find("input[name='order_product_timeid']"),flag:flag}),_.data.id=e},t.prototype.setEdit=function(e){var t=this;if(type=t.type="edit",r="修改司机/装箱信息",l="修改成功！",this.address_list=[],t.DOM.items_container.html(""),t.DOM.items_complete_container.html(""),t.driverSelector.setSelectedText(e.driver_info.name+"/"+e.driver_info.car_number),t.driverSelector.setSelectedVal(e.driver_info.id),"boolean"!=typeof e.driver_info.driver_can_change||e.driver_info.driver_can_change?(t.pop.find(".driver-name").text(e.driver_info.name).hide(),t.DOM.driver.show()):(t.pop.find(".driver-name").text(e.driver_info.name).show(),t.DOM.driver.hide()),0==e.address_info.length){flag=t.flag=1;var d=$(item_tpl({flag:flag,canChange:!0,assign_driver_id:"",order_product_timeid:""}));t.DOM.items_container.html(d);var i=new select({width:380,container:d.find(".boxData-selector"),options:[],defaultText:"请选择装箱时间",defaultValue:"0",options_max_height:160,onSelectChange:function(e,t,d){d.select.select_box.removeClass("error")}}),s=new select({width:380,container:d.find(".boxAddress-selector"),options:a,defaultText:"请选择装箱地址",defaultValue:"0",onSelectChange:function(e,t,d){d.select.select_box.removeClass("error"),i.setSelectedVal(""),i.setSelectedText("请先选择装箱地址"),i.setOptions([]),function(e){o=[];for(var t=0;t<_.select_options[t].length;t++)if(e==_.select_options[t].product_address_id)for(var d=_.select_options[t].box_date,i=0;i<d.length;i++)o.push({value:d[i].product_time_id,text:d[i].product_supply_time})}(e),i.setSelectedText("请选择装箱时间"),i.setOptions(o)}});t.address_list.push({address:s,time:i,assign_id:d.find("input[name='assign_driver_id']"),order_product_addressid:d.find("input[name='order_product_addressid']"),order_product_timeid:d.find("input[name='order_product_timeid']"),flag:flag})}else for(var n=1,c=0;c<e.address_info.length;c++){if(e.address_info[c].assign_status>2){var p=$(complete_item_tpl({box_address_detail:e.address_info[c].box_address_detail,box_time:e.address_info[c].box_time}));t.DOM.items_complete_container.append(p)}var m=!1;e.address_info[c].assign_status<3&&(m=!0);var d=$(item_tpl({flag:n,canChange:m,assign_driver_id:e.address_info[c].assign_id,order_product_addressid:e.address_info[c].product_address_id,order_product_timeid:e.address_info[c].product_time_id}));t.DOM.items_container.append(d),function(e){o=[];for(var t=0;t<_.select_options.length;t++)if(e==_.select_options[t].product_address_id)for(var d=_.select_options[t].box_date,i=0;i<d.length;i++)o.push({value:d[i].product_time_id,text:d[i].product_supply_time})}(e.address_info[c].product_address_id);var u=d.find(".boxData-selector"),f=d.find(".boxAddress-selector");if(0!==u.length||0!==f.length){var i=new select({width:380,container:d.find(".boxData-selector"),options:o,defaultText:e.address_info[c].box_time,defaultValue:e.address_info[c].product_time_id,options_max_height:160,onSelectChange:function(e,t,d){d.select.select_box.removeClass("error")}}),s=new select({width:380,container:d.find(".boxAddress-selector"),options:a,defaultText:e.address_info[c].box_address_detail,defaultValue:e.address_info[c].product_address_id,onSelectChange:function(e,t,d){d.select.select_box.removeClass("error"),i.setSelectedVal(""),i.setSelectedText("请先选择装箱地址"),i.setOptions([]),function(e){o=[];for(var t=0;t<_.select_options.length;t++)if(e==_.select_options[t].product_address_id)for(var d=_.select_options[t].box_date,i=0;i<d.length;i++)o.push({value:d[i].product_time_id,text:d[i].product_supply_time})}(e),i.setSelectedText("请选择装箱时间"),i.setOptions(o)}});t.address_list.push({address:s,time:i,assign_id:d.find("input[name='assign_driver_id']"),order_product_timeid:d.find("input[name='order_product_timeid']"),order_product_addressid:d.find("input[name='order_product_addressid']"),order_product_timeid:d.find("input[name='order_product_timeid']"),flag:n})}else t.address_list.push({assign_id:d.find("input[name='assign_driver_id']"),order_product_addressid:d.find("input[name='order_product_addressid']"),order_product_timeid:d.find("input[name='order_product_timeid']"),flag:n});n++}_.data.id=e.box_id},t.prototype.onComplete=function(){},t.prototype.init_popup=function(){var e=this;e.DOM.title.text(r),XDD.Request({url:"/carteam/order/choose_driver",type:"post",data:{carTeamId:_.carTeam_id},success:function(t){if(0!=t.error_code)return void(e.msg=t.error_msg||"未知错误！");var d=t.data,i=d.length;if(0==i)return void(e.msg="您未添加司机信息，请与管理员联系！");for(var s,r=[],s=0;i>s;s++)r.push({value:d[s].userid,text:d[s].driver_name+"/"+d[s].car_number});e.driverSelector=new select({width:380,container:e.DOM.driver,options:r,defaultText:"请选择司机",defaultValue:"",onSelectChange:function(e,t,d){d.select.select_box.removeClass("error")}}),e.can_open=!0,e.msg=""}},!0)},new t}var popup=require("common/module/popup/popup.js"),tpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div id="assignPop"><div class="assignPop-title clearfix"><div class="assignPop-cancel"><button class="cancelBtn">取消</button></div><div class="title-text">上传信息</div><div class="assignPop-comfire"><button class="comfireBtn">确定</button></div></div><dl class="assignPop-driver-item first clearfix"><dd class="item"><div class="item-name"><label for="assignPop-seal-num">司机：</label></div><div class="item-content"><p class="driver-name"></p>                <div id="driver-selector"></div></div>            <div class="item-message clearfix">                <div class="error-message hidden"><i class="icon-warn"></i></div>                <div class="right-message hidden"><i class="icon-right"></i></div>            </div></dd></dl><div class="assignPop-address-complete-info"></div><div class="assignPop-address-info"></div><button class="add-other-BoxInfo">添加其他产装信息</button></div>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],item_tpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<dl class="assign-adrress-items '),canChange||_template_fun_array.push("hidden"),_template_fun_array.push('" data-flag="',"undefined"==typeof flag?"":baidu.template._encodeHTML(flag),'"><div class="clearfix address-bottom-line"></div><input type="hidden" class="assign_driver_id" name="assign_driver_id" value="',"undefined"==typeof assign_driver_id?"":baidu.template._encodeHTML(assign_driver_id),'"/><input type="hidden" class="order_product_addressid" name="order_product_addressid" value="',"undefined"==typeof order_product_addressid?"":baidu.template._encodeHTML(order_product_addressid),'"/><input type="hidden" class="order_product_timeid" name="order_product_timeid" value="',"undefined"==typeof order_product_timeid?"":baidu.template._encodeHTML(order_product_timeid),'"/>'),canChange&&_template_fun_array.push('<dd class="item"><div class="item-name"><label for="assignPop-seal-num">装箱地址：</label></div><div class="item-content">            <div class="boxAddress-selector"></div></div>        <div class="item-message clearfix">            <div class="error-message hidden"><i class="icon-warn"></i></div>            <div class="right-message hidden"><i class="icon-right"></i></div>        </div></dd><div class="assign-delContainer"></div><dd class="item"><div class="item-name"><label for="assignPop-seal-num">装箱时间：</label></div><div class="item-content">            <div class="boxData-selector"></div></div>        <div class="item-message clearfix">            <div class="error-message hidden"><i class="icon-warn"></i></div>            <div class="right-message hidden"><i class="icon-right"></i></div>        </div></dd>'),_template_fun_array.push("</dl>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],complete_item_tpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<dl class="assign-adrress-complete-items"><div class="clearfix address-bottom-line"></div><dd class="item"><div class="item-name"><label>详细装箱地址：</label></div><div class="item-content">',"undefined"==typeof box_address_detail?"":baidu.template._encodeHTML(box_address_detail),'</div></dd><div class="assign-delContainer"></div><dd class="item"><div class="item-name"><label for="assignPop-seal-num">装箱时间：</label></div><div class="item-content">',"undefined"==typeof box_time?"":baidu.template._encodeHTML(box_time),"</div></dd></dl>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],select=require("common/module/select/select.js");module.exports=AssignPop});